# QuantitativeProgram 服务器部署完整指令

## 一、准备工作

### 1. 确保代码已推送到 GitHub

```bash
# 在本地项目目录执行
git add .
git commit -m "准备部署"
git push origin main  # 或 master，根据你的分支名
```

### 2. 记录 GitHub 仓库地址

仓库地址：`https://github.com/erling-9/Quantitative-Program.git`

## 二、在服务器上执行部署

### 方式一：使用自动部署脚本（推荐）

#### 步骤 1：登录服务器并克隆仓库

```bash
# 创建部署目录
sudo mkdir -p /opt/quantitative-program
cd /opt/quantitative-program

# 克隆 GitHub 仓库
sudo git clone https://github.com/erling-9/Quantitative-Program.git .

# 或者如果已经克隆过，更新代码
cd /opt/quantitative-program
sudo git pull
```

#### 步骤 2：修改部署脚本配置

```bash
sudo nano deploy.sh
```

检查并修改以下配置（如需要）：
- `GITHUB_REPO_URL`：已配置为 `https://github.com/erling-9/Quantitative-Program.git`
- `DEPLOY_DIR`：部署目录（默认 `/opt/quantitative-program`，可按需修改）
- `SERVICE_USER`：运行服务的用户（默认 `www-data`，如果不存在可以改为 `root`）

#### 步骤 3：执行部署脚本

```bash
sudo chmod +x deploy.sh
sudo ./deploy.sh
```

### 方式二：手动部署

#### 步骤 1：安装系统依赖

```bash
sudo apt-get update
sudo apt-get install -y python3 python3-pip python3-venv git nginx
```

#### 步骤 2：克隆代码

```bash
sudo mkdir -p /opt/quantitative-program
cd /opt/quantitative-program
sudo git clone https://github.com/erling-9/Quantitative-Program.git .
```

#### 步骤 3：创建虚拟环境并安装依赖

```bash
cd /opt/quantitative-program
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
pip install gunicorn
```

#### 步骤 4：创建必要目录

```bash
mkdir -p uploads logs
```

#### 步骤 5：创建 systemd 服务

```bash
sudo nano /etc/systemd/system/quantitative-program.service
```

粘贴以下内容（注意修改路径和用户）：

```ini
[Unit]
Description=Quantitative Program Trading Signal Server
After=network.target

[Service]
Type=notify
User=www-data
WorkingDirectory=/opt/quantitative-program
Environment="PATH=/opt/quantitative-program/venv/bin"
ExecStart=/opt/quantitative-program/venv/bin/gunicorn --bind 0.0.0.0:8000 --workers 4 --timeout 300 --config /opt/quantitative-program/gunicorn_config.py server:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**注意**：如果 `www-data` 用户不存在，可以：
- 改为 `root`（不推荐，但简单）
- 或创建新用户：`sudo useradd -r -s /bin/false www-data`

#### 步骤 6：设置文件权限

```bash
sudo chown -R www-data:www-data /opt/quantitative-program
# 或者如果使用 root
# sudo chown -R root:root /opt/quantitative-program
```

#### 步骤 7：启动服务

```bash
sudo systemctl daemon-reload
sudo systemctl enable quantitative-program
sudo systemctl start quantitative-program
sudo systemctl status quantitative-program
```

## 三、配置 Nginx 反向代理（可选但推荐）

### 步骤 1：创建 Nginx 配置

```bash
sudo nano /etc/nginx/sites-available/quantitative-program
```

粘贴以下内容（修改 `server_name` 为你的域名或 IP）：

```nginx
server {
    listen 80;
    server_name your_server_ip_or_domain;  # 改为你的服务器IP或域名

    client_max_body_size 100M;

    access_log /var/log/nginx/quantitative-program-access.log;
    error_log /var/log/nginx/quantitative-program-error.log;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    location /health {
        proxy_pass http://127.0.0.1:8000/health;
        access_log off;
    }
}
```

### 步骤 2：启用配置

```bash
sudo ln -s /etc/nginx/sites-available/quantitative-program /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置是否正确
sudo systemctl restart nginx
```

## 四、配置防火墙

```bash
# Ubuntu/Debian (UFW)
sudo ufw allow 8000/tcp
sudo ufw allow 80/tcp
sudo ufw status

# CentOS/RHEL (firewalld)
sudo firewall-cmd --permanent --add-port=8000/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --reload
```

## 五、验证部署

### 1. 检查服务状态

```bash
sudo systemctl status quantitative-program
```

应该显示 `active (running)`

### 2. 测试 API

```bash
# 在服务器上测试
curl http://localhost:8000/health

# 或从外部测试（替换为你的服务器IP）
curl http://YOUR_SERVER_IP:8000/health
```

应该返回：
```json
{"status":"ok","models_loaded":false}
```

### 3. 查看日志

```bash
# 服务日志
sudo journalctl -u quantitative-program -f

# 应用日志
tail -f /opt/quantitative-program/logs/error.log
```

## 六、常用管理命令

```bash
# 查看服务状态
sudo systemctl status quantitative-program

# 启动服务
sudo systemctl start quantitative-program

# 停止服务
sudo systemctl stop quantitative-program

# 重启服务
sudo systemctl restart quantitative-program

# 查看实时日志
sudo journalctl -u quantitative-program -f

# 查看最近 100 行日志
sudo journalctl -u quantitative-program -n 100

# 更新代码后重启
cd /opt/quantitative-program
sudo git pull
sudo systemctl restart quantitative-program
```

## 七、故障排查

### 问题 1：服务无法启动

```bash
# 查看详细错误
sudo journalctl -u quantitative-program -n 50

# 检查端口是否被占用
sudo netstat -tlnp | grep 8000

# 手动测试运行
cd /opt/quantitative-program
source venv/bin/activate
python server.py
```

### 问题 2：无法访问 API

1. 检查服务是否运行：`sudo systemctl status quantitative-program`
2. 检查防火墙：`sudo ufw status`
3. 检查端口监听：`sudo netstat -tlnp | grep 8000`
4. 测试本地连接：`curl http://localhost:8000/health`

### 问题 3：权限问题

```bash
# 确保目录权限正确
sudo chown -R www-data:www-data /opt/quantitative-program
sudo chmod -R 755 /opt/quantitative-program
```

## 八、完成！

部署完成后，你的 API 可以通过以下地址访问：

- 直接访问：`http://YOUR_SERVER_IP:8000`
- 通过 Nginx：`http://YOUR_SERVER_IP` 或 `http://your_domain.com`

**重要提示**：
1. 服务已设置为开机自启，服务器重启后会自动启动
2. 服务崩溃会自动重启（Restart=always）
3. 代码更新后需要重启服务：`sudo systemctl restart quantitative-program`

