# GitHub Actions 自动部署配置说明

## 概述

现在项目已配置 GitHub Actions 自动部署工作流。当你推送代码到 `main` 或 `master` 分支时，GitHub Actions 会自动：
1. 通过 SSH 连接到服务器
2. 拉取最新代码
3. 安装新的依赖（如果有）
4. 重启服务

## 配置步骤

### 1. 在服务器上配置 SSH 密钥

#### 1.1 生成 SSH 密钥对（如果还没有）

```bash
# 在服务器上执行
ssh-keygen -t rsa -b 4096 -C "github-actions-deploy"
# 按回车使用默认路径，或指定路径
# 可以设置密码，也可以留空
```

#### 1.2 将公钥添加到 authorized_keys

```bash
# 将公钥添加到授权列表
cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

#### 1.3 获取私钥内容

```bash
# 查看私钥内容（需要复制给 GitHub）
cat ~/.ssh/id_rsa
```

**重要**：复制整个私钥内容（包括 `-----BEGIN RSA PRIVATE KEY-----` 和 `-----END RSA PRIVATE KEY-----`）

### 2. 在 GitHub 仓库中配置 Secrets

1. 打开你的 GitHub 仓库：`https://github.com/erling-9/Quantitative-Program`
2. 点击 **Settings**（设置）
3. 在左侧菜单中找到 **Secrets and variables** → **Actions**
4. 点击 **New repository secret** 添加以下三个密钥：

#### 2.1 添加 SSH_HOST

- **Name**: `SSH_HOST`
- **Value**: 你的服务器 IP 地址或域名
  - 例如：`123.456.789.0` 或 `your-server.com`

#### 2.2 添加 SSH_USER

- **Name**: `SSH_USER`
- **Value**: SSH 登录用户名
  - 例如：`root` 或 `ubuntu` 或 `deploy`

#### 2.3 添加 SSH_PRIVATE_KEY

- **Name**: `SSH_PRIVATE_KEY`
- **Value**: 刚才复制的私钥内容（完整内容，包括首尾的 `-----BEGIN...` 和 `-----END...`）

### 3. 配置服务器上的 sudo 权限（如果需要）

如果部署脚本需要执行 `sudo systemctl restart`，需要配置无密码 sudo：

```bash
# 编辑 sudoers 文件
sudo visudo

# 添加以下行（将 username 替换为你的 SSH 用户名）
username ALL=(ALL) NOPASSWD: /bin/systemctl restart quantitative-program
username ALL=(ALL) NOPASSWD: /bin/systemctl status quantitative-program
```

或者，如果 SSH 用户就是 root，则不需要配置 sudo。

### 4. 测试自动部署

1. 在本地修改任意文件（比如 README.md）
2. 提交并推送到 GitHub：

```bash
git add .
git commit -m "测试自动部署"
git push origin main  # 或 master
```

3. 在 GitHub 仓库页面，点击 **Actions** 标签页
4. 查看部署工作流是否成功执行
5. 如果失败，点击查看详细日志

## 工作流说明

### 触发条件

- 推送到 `main` 分支
- 推送到 `master` 分支

### 执行步骤

1. **检查代码**：从 GitHub 仓库检出代码
2. **配置 SSH**：使用配置的 SSH 密钥建立连接
3. **部署到服务器**：
   - 进入部署目录 `/opt/quantitative-program`
   - 执行 `git pull` 拉取最新代码
   - 检查并安装新的 Python 依赖
   - 重启 `quantitative-program` 服务
   - 检查服务状态

## 故障排查

### 问题 1：SSH 连接失败

**错误信息**：`Permission denied (publickey)`

**解决方法**：
1. 检查 SSH_PRIVATE_KEY 是否正确配置（包括首尾的标记）
2. 检查 SSH_HOST 和 SSH_USER 是否正确
3. 确认服务器上的公钥已添加到 authorized_keys
4. 检查服务器 SSH 服务是否正常运行：`sudo systemctl status ssh`

### 问题 2：sudo 权限不足

**错误信息**：`sudo: a password is required`

**解决方法**：
1. 按照步骤 3 配置无密码 sudo
2. 或者修改 `.github/workflows/deploy.yml`，使用 root 用户登录

### 问题 3：服务重启失败

**错误信息**：`Failed to restart quantitative-program.service`

**解决方法**：
1. 在服务器上手动检查服务状态：`sudo systemctl status quantitative-program`
2. 查看服务日志：`sudo journalctl -u quantitative-program -n 50`
3. 确认服务文件存在：`ls /etc/systemd/system/quantitative-program.service`

### 问题 4：git pull 失败

**错误信息**：`fatal: not a git repository`

**解决方法**：
1. 确认部署目录 `/opt/quantitative-program` 存在
2. 确认该目录是一个 git 仓库（包含 `.git` 文件夹）
3. 如果不存在，需要先手动执行一次初始部署（参考 `部署指令.md`）

## 安全建议

1. **使用专用部署用户**：不要使用 root 用户，创建一个专门的部署用户
2. **限制 SSH 访问**：在服务器上配置防火墙，只允许特定 IP 访问 SSH
3. **定期轮换密钥**：定期更换 SSH 密钥
4. **监控部署日志**：定期检查 GitHub Actions 的部署日志

## 手动部署（备用方案）

如果自动部署失败，可以手动在服务器上执行：

```bash
cd /opt/quantitative-program
git pull origin main  # 或 master
sudo systemctl restart quantitative-program
```

## 完成！

配置完成后，每次推送代码到 main/master 分支，服务器就会自动更新！

查看部署历史：在 GitHub 仓库的 **Actions** 标签页中查看所有部署记录。






